# 支付宝支付功能配置指南

## 功能说明

本项目已集成支付宝沙箱支付功能，用户可以在订单页面点击"去支付"按钮，跳转到支付宝沙箱环境进行支付测试。

## 配置步骤

### 1. 注册支付宝开放平台账号

1. 访问 [支付宝开放平台](https://open.alipay.com/)
2. 使用支付宝账号登录
3. 进入"控制台" -> "沙箱"

### 2. 获取沙箱应用信息

在沙箱页面，你可以看到：
- **APPID**: 沙箱应用ID
- **沙箱账号**: 提供的买家和卖家账号

### 3. 生成密钥

#### 方法一：使用支付宝密钥生成工具（推荐）

1. 下载 [支付宝密钥生成工具](https://opendocs.alipay.com/common/02kipl)
2. 运行工具，选择"RSA2"和"PKCS1"格式
3. 点击"生成密钥"
4. 保存生成的**应用私钥**（备用）

#### 方法二：使用OpenSSL命令行

```bash
# 生成应用私钥
openssl genrsa -out app_private_key.pem 2048

# 提取公钥
openssl rsa -in app_private_key.pem -pubout -out app_public_key.pem
```

### 4. 上传公钥到支付宝

1. 在沙箱应用页面，找到"接口加签方式"设置
2. 选择"设置" -> "公钥"模式
3. 将步骤3生成的**应用公钥**复制粘贴到"公钥"输入框
4. 点击"保存"，支付宝会生成对应的**支付宝公钥**
5. 复制保存**支付宝公钥**（备用）

### 5. 配置项目参数

编辑 `src/main/resources/application-dev.yml` 文件：

```yaml
alipay:
  gateway: https://openapi.alipaydev.com/gateway.do
  app-id: 你的沙箱应用APPID
  private-key: 你的应用私钥（MIIEvQIBADANBgkqhkiG9w0B...）
  alipay-public-key: 支付宝公钥（MIIBIjANBgkqhkiG9w0B...）
  return-url: http://localhost:5174/payment/return
  notify-url: http://localhost:8080/payment/notify
  sign-type: RSA2
```

**注意事项**：
- `private-key` 和 `alipay-public-key` 需要填写完整的密钥内容（包括 `-----BEGIN PRIVATE KEY-----` 和 `-----END PRIVATE KEY-----`）
- 密钥内容需要换行并保持正确的缩进

#### 密钥格式示例

```yaml
alipay:
  private-key: |
    -----BEGIN PRIVATE KEY-----
    MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC5...
    ...（密钥内容）...
    ...（密钥内容）...
    -----END PRIVATE KEY-----
  alipay-public-key: |
    -----BEGIN PUBLIC KEY-----
    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
    ...（密钥内容）...
    ...（密钥内容）...
    -----END PUBLIC KEY-----
```

### 6. 重启后端服务

配置完成后，需要重启后端服务以加载新的配置：

```bash
cd D:\test\project\emart
./mvnw spring-boot:run
```

## 测试流程

### 1. 准备测试账号

在支付宝沙箱页面，提供了以下测试账号：
- **买家账号**: 用于模拟用户支付
- **密码**: 显示在页面上
- **卖家账号**: 用于接收款项

### 2. 支付测试流程

1. **注册登录**: 在用户前台注册并登录
2. **浏览商品**: 选择商品加入购物车
3. **创建订单**: 从购物车结算，填写收货地址，提交订单
4. **发起支付**: 在"我的订单"页面，找到"待付款"状态的订单，点击"去支付"按钮
5. **沙箱支付**:
   - 自动跳转到支付宝沙箱登录页面
   - 使用买家账号登录
   - 确认支付信息，完成支付
6. **支付完成**: 支付宝会自动跳转回前端的支付成功页面
7. **查看订单**: 在"我的订单"页面，订单状态已更新为"待发货"

## 功能特点

### 后端功能

1. **支付发起**: `/payment/pay/{orderId}`
   - 生成支付宝支付表单
   - 返回HTML表单给前端

2. **同步回调**: `/payment/return`
   - 支付完成后用户浏览器自动跳转
   - 更新订单状态为"已付款"
   - 重定向到前端订单页面

3. **异步通知**: `/payment/notify`
   - 支付宝服务器异步通知
   - 验证签名并更新订单状态
   - 返回success给支付宝

### 前端功能

1. **支付按钮**: 订单列表页的"去支付"按钮
2. **表单提交**: 自动显示并提交支付宝表单
3. **支付返回**: 支付成功后的展示页面

## API接口

### 发起支付

**请求**:
```
POST /payment/pay/{orderId}
```

**响应**:
```json
{
  "code": 200,
  "message": "支付发起成功",
  "data": "<form>...</form>"  // 支付宝支付表单HTML
}
```

## 常见问题

### Q1: 支付时提示"应用不存在"或"无效的AppID"

**原因**: APPID配置错误

**解决方案**:
1. 检查 `application-dev.yml` 中的 `app-id` 是否正确
2. 确认使用的是沙箱APPID（不是正式环境的APPID）
3. 确保沙箱应用已启用

### Q2: 支付时提示"签名验证失败"

**原因**: 密钥配置不正确

**解决方案**:
1. 检查 `private-key` 是否是应用私钥（不是公钥）
2. 检查 `alipay-public-key` 是否是支付宝公钥（不是应用公钥）
3. 确保密钥格式正确，包含 `-----BEGIN PRIVATE KEY-----` 等标记
4. 密钥内容需要使用 `|` 符号进行多行配置

### Q3: 支付后订单状态未更新

**原因**: 回调地址无法访问

**解决方案**:
1. 检查 `return-url` 和 `notify-url` 配置是否正确
2. 确保后端服务正在运行
3. 如果使用本地开发，需要确保端口8080可访问
4. 检查后端日志，确认是否收到回调请求

### Q4: 沙箱账号无法登录

**原因**: 密码输入错误或账号已过期

**解决方案**:
1. 重新生成沙箱账号
2. 复制粘贴密码（注意不要有空格）
3. 沙箱账号有时效性，定期刷新

### Q5: 支付成功但未跳转回页面

**原因**: return-url配置错误

**解决方案**:
1. 检查 `return-url` 是否正确配置为 `http://localhost:5174/payment/return`
2. 确保前端服务正在运行
3. 检查浏览器控制台是否有错误

## 安全建议

### 生产环境配置

1. **使用正式环境**:
   ```yaml
   gateway: https://openapi.alipay.com/gateway.do
   ```

2. **启用签名验证**:
   - 在支付回调中验证支付宝签名
   - 防止伪造通知

3. **使用HTTPS**:
   - return-url 和 notify-url 使用HTTPS协议
   - 确保数据传输安全

4. **密钥管理**:
   - 不要将密钥提交到版本控制
   - 使用环境变量或配置中心管理密钥
   - 定期更换密钥

## 进阶功能

### 1. 退款功能

可以扩展实现退款功能：
```java
AlipayTradeRefundRequest request = new AlipayTradeRefundRequest();
request.setBizContent("{\"out_trade_no\":\"" + orderNo + "\","
        + "\"refund_amount\":\"" + amount + "\"}");
```

### 2. 查询订单

可以查询支付宝订单状态：
```java
AlipayTradeQueryRequest request = new AlipayTradeQueryRequest();
request.setBizContent("{\"out_trade_no\":\"" + orderNo + "\"}");
```

### 3. 关闭订单

可以关闭未支付订单：
```java
AlipayTradeCloseRequest request = new AlipayTradeCloseRequest();
request.setBizContent("{\"out_trade_no\":\"" + orderNo + "\"}");
```

## 技术支持

- [支付宝开放平台文档](https://opendocs.alipay.com/)
- [支付宝沙箱环境](https://open.alipay.com/develop/sandbox/app)
- [支付接入指南](https://opendocs.alipay.com/open/270)

## 更新日志

- 2025-12-28: 初始版本，支持沙箱支付功能
  - 集成Alipay SDK
  - 实现支付发起、同步回调、异步通知
  - 创建前端支付页面

---

**注意**: 此功能使用支付宝沙箱环境进行测试，仅用于开发和学习目的。生产环境需要申请正式的支付宝应用。
